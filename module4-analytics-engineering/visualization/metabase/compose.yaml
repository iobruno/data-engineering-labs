x-metabase-image: &metabase-image metabase/metabase:${METABASE_VERSION:-v0.58.x}
x-postgres-image: &postgres-image postgres:${POSTGRES_VERSION:-18.1-alpine}
x-metabase-setup-image: &metabase-setup-image curlimages/curl:${CURL_VERSION:-latest}

x-metabase-common: &metabase-common
  image: *metabase-image
  user: "${MUID:-2000}:${MGID:-2000}"
  environment:
    MB_DB_TYPE: postgres
    MB_DB_HOST: metabase-db
    MB_DB_PORT: 5432
    MB_DB_DBNAME: metabase
    MB_DB_USER: metabase
    MB_DB_PASS: metabase
    MB_PLUGINS_DIR: ${MB_PLUGINS_DIR:-/app/plugins}
    MB_PASSWORD_LENGTH: 4
    MB_PASSWORD_COMPLEXITY: weak
    MUID: ${MUID:-2000}
    MGID: ${MGID:-2000}
  volumes:
    - vol-metabase-data:/metabase-data
    - vol-metabase-plugins:${MB_PLUGINS_DIR:-/app/plugins}

services:
  metabase-db:
    image: *postgres-image
    container_name: metabase-db
    environment:
      POSTGRES_USER: 'metabase'
      POSTGRES_PASSWORD: 'metabase'
      POSTGRES_DB: 'metabase'
    ports:
      - '5433:5432'
    volumes:
      - vol-metabase-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: on-failure

  metabase:
    <<: *metabase-common
    container_name: metabase
    ports:
      - 3000:3000
    depends_on:
      metabase-db:
        condition: service_healthy
      metabase-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:3000/api/health"]
      interval: 5s
      timeout: 10s
      retries: 5
    restart: on-failure:5

  metabase-setup:
    image: *metabase-setup-image
    container_name: metabase-setup
    entrypoint: ["sh", "-c"]
    command:
      - |
        TOKEN=$$(curl -sf http://metabase:3000/api/session/properties | grep -o '"setup-token":"[^"]*"' | cut -d'"' -f4)
        if [ -z "$$TOKEN" ] || [ "$$TOKEN" = "null" ]; then
          echo "Metabase already configured, skipping setup"
          exit 0
        fi

        echo "Setting up Metabase admin user..."
        curl -sf -X POST http://metabase:3000/api/setup \
          -H 'Content-Type: application/json' \
          -d '{
            "token": "'"$$TOKEN"'",
            "user": {
              "first_name": "Admin",
              "last_name": "Metabase",
              "email": "admin@metabase.local",
              "password": "admin",
              "password_confirm": "admin"
            },
            "prefs": {
              "site_name": "Metabase",
              "site_locale": "en_US",
              "allow_tracking": false
            }
          }' && echo ""
          
          echo "Metabase setup complete!"
    depends_on:
      metabase:
        condition: service_healthy
    restart: "no"

  metabase-init:
    <<: *metabase-common
    container_name: metabase-init
    user: "0:0"
    entrypoint: /bin/bash
    command:
      - -c
      - |
        mkdir -p $${MB_PLUGINS_DIR}
        curl -L -o $${MB_PLUGINS_DIR}/clickhouse.metabase-driver.jar https://github.com/motherduckdb/metabase_duckdb_driver/releases/download/1.4.3.1/duckdb.metabase-driver.jar
        chown -R $${MUID}:$${MGID} $${MB_PLUGINS_DIR}

volumes:
  vol-metabase-db:
    name: vol-metabase-db
  vol-metabase-data:
    name: vol-metabase-data
  vol-metabase-plugins:
    name: vol-metabase-plugins
